<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.15" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <link rel="stylesheet" href="http://sunwxg.github.io/css/bootstrap-3.3.6.min.css">
    <link rel="stylesheet" href="http://sunwxg.github.io/css/font-awesome-4.5.0.min.css">
    <link rel="stylesheet" href="http://sunwxg.github.io/css/theme_style.css">
    

    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://sunwxg.github.io//index.xml">

    
    <title>Use libwireshark decoding PCAP files - Sun Wang&#39;s Blog</title>
    <meta property='og:title' content="Use libwireshark decoding PCAP files - Sun Wang&#39;s Blog">
    <meta property="og:type" content="article">
    

    <meta property="og:url" content="http://sunwxg.github.io/post/use-libwireshark-decode-packet/">
    <meta name="description" content="Use libwireshark library to decode PCAP file in C code.">
    
</head>

<body>


    <div class="container">

      
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://sunwxg.github.io/">Sun Wang&#39;s Blog</a>
          </div>

	<a class="navbar-brand navbar-right" href="http://sunwxg.github.io/about/">About</a>
	<a class="navbar-text" href="https://github.com/sunwxg">github</a>
      </nav>


<div class="row">
    <div class="col-lg-8">

        <article class="single well" itemscope="itemscope" itemtype="http://schema.org/Article">
            <meta itemprop="mainEntityOfPage"  itemType="https://schema.org/WebPage" content="http://sunwxg.github.io/"/>
            <meta itemprop="dateModified" content="2016-03-23T00:00:00&#43;00:00">
            <meta itemprop="headline" content="Use libwireshark decoding PCAP files">
            <meta itemprop="description" content="We use Wireshark tool to decode IP packet and analyse signaling. If we want to write our own tool to decode packet, we can use libwireshark library. First do some initial work. init_process_policies(); epan_init(register_all_protocols, register_all_protocol_handoffs, NULL, NULL); /* cfile is a global varible */ cap_file_init(&amp;cfile); cfile.filename = filename; cfile.count = 0; cfile.epan = epan_new(); cfile.epan-&gt;data = &amp;cfile; cfile.epan-&gt;get_frame_ts = tshark_get_frame_ts; Second read and decode packet. Function wtap_read read one packet from file.">
            <meta itemprop="url" content="http://sunwxg.github.io/post/use-libwireshark-decode-packet/">
            <div itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
                <meta itemprop="url" content="http://sunwxg.github.io/images/default.jpg" />
                <meta itemprop="width" content="800">
                <meta itemprop="height" content="800">
            </div>
            <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
                <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
                    <meta itemprop="url" content="http://sunwxg.github.io/images/logo.jpg">
                    <meta itemprop="width" content="100">
                    <meta itemprop="height" content="100">
                </div>
                <meta itemprop="name" content="Sun Wang&#39;s Blog">
            </div>
            <div itemprop="author" itemscope itemtype="https://schema.org/Person">
                <meta itemprop="name" content="">
            </div>

            <header class="article-header">
                <h1>Use libwireshark decoding PCAP files</h1>
                
                <time itemprop="datePublished" pubdate="pubdate" datetime="2016-03-23T00:00:00&#43;00:00"><i class="fa fa-clock-o"></i> Posted on March 23, 2016</time>
                

                <div class="fa fa-tags">
                 <a href="http://sunwxg.github.io/tags/wireshark" class="tag">wireshark</a> 
		</div>

            </header>

            <p><p>We use Wireshark tool to decode IP packet and analyse signaling. If we want to write our own tool to decode packet, we can use libwireshark library.</p>

<p>First do some initial work.</p>

<pre><code class="language-C">init_process_policies();

epan_init(register_all_protocols, register_all_protocol_handoffs, NULL, NULL);

/* cfile is a global varible */
cap_file_init(&amp;cfile);
cfile.filename = filename;

cfile.count = 0;
cfile.epan = epan_new();
cfile.epan-&gt;data = &amp;cfile;
cfile.epan-&gt;get_frame_ts = tshark_get_frame_ts;
</code></pre>

<p>Second read and decode packet.</p>

<p>Function <code>wtap_read</code> read one packet from file.</p>

<p>Function <code>epan_dissect_new</code> create a new <code>struct epan_dissect_t</code>.</p>

<p>Function <code>epan_dissect_run</code> decode packet.</p>

<pre><code class="language-C">if (wtap_read(cfile.wth, &amp;err, &amp;err_info, &amp;data_offset)) {

	cfile.count++;

	frame_data fdlocal;
	frame_data_init(&amp;fdlocal, cfile.count, whdr, data_offset, cum_bytes);

	edt = epan_dissect_new(cfile.epan, TRUE, TRUE);

	frame_data_set_before_dissect(&amp;fdlocal, &amp;cfile.elapsed_time, &amp;cfile.ref, cfile.prev_dis);
	cfile.ref = &amp;fdlocal;

	epan_dissect_run(edt, cfile.cd_t, &amp;(cfile.phdr), frame_tvbuff_new(&amp;fdlocal, buf), &amp;fdlocal, &amp;cfile.cinfo);

	frame_data_set_after_dissect(&amp;fdlocal, &amp;cum_bytes);
	cfile.prev_cap = cfile.prev_dis = frame_data_sequence_add(cfile.frames, &amp;fdlocal);

	//free space
	frame_data_destroy(&amp;fdlocal);

	*edt_r = edt;
	return TRUE;
}
return FALSE;
</code></pre>

<p>Print out packet.</p>

<pre><code class="language-C">/* print out as XML format */
proto_tree_write_pdml(edt, stdout);

/* print out as TEXT format */
proto_tree_print(&amp;print_args, edt, print_stream);
</code></pre>

<p>Release memory.</p>

<pre><code class="language-C">epan_dissect_free(edt);
edt = NULL;

free_frame_data_sequence(cfile.frames);
cfile.frames = NULL;

wtap_close(cfile.wth);
cfile.wth = NULL;

epan_free(cfile.epan);

epan_cleanup();
</code></pre>

<p>My source code is on <a href="https://github.com/sunwxg/decode_by_libwireshark">github</a>. You can follow the guide to run and debug.</p>
</p>

        </article>

    </div>
    <aside class="col-md-4">

  
  <div class="well">
    <h3 class="text-capitalize">category</h3>
    <ul class="list-unstyled">
      
      <li><a href="http://sunwxg.github.io/categories/blog">blog</a></li>
      
    </ul>
  </div>
  
  <div class="well">
    <h3 class="text-capitalize">tag</h3>
    <ul class="list-unstyled">
      
      <li><a href="http://sunwxg.github.io/tags/linux">linux</a></li>
      
      <li><a href="http://sunwxg.github.io/tags/wireshark">wireshark</a></li>
      
      <li><a href="http://sunwxg.github.io/tags/kernel">kernel</a></li>
      
      <li><a href="http://sunwxg.github.io/tags/jekyll">jekyll</a></li>
      
      <li><a href="http://sunwxg.github.io/tags/sun-pinyin">sun-pinyin</a></li>
      
      <li><a href="http://sunwxg.github.io/tags/driver">driver</a></li>
      
    </ul>
  </div>
  

</aside>

</div>
            <footer>
                <div class="row">
                    

                    <p>&copy; 2016 Sun Wang&#39;s Blog</p>
                    <p>Powered by <a href="http://gohugo.io" target="_blank">Hugo</a>,</p>
                    <p>Theme <a href="https://github.com/sunwxg/my_blog" target="_blank">sun</a> designed by <a href="http://sunwxg.github.io" target="_blank">Sun Wang</a></p>

                    
                </div>
            </footer>
        </div>

        <script src="http://sunwxg.github.io/js/jquery-2.2.0.min.js"></script>
        <script src="http://sunwxg.github.io/js/bootstrap-3.3.6.min.js"></script>
    </body>
</html>

